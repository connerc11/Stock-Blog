<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>SleepLess Stock Thoughts</title>
  <script src="https://cdn.jsdelivr.net/npm/react@18.2.0/umd/react.production.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/react-dom@18.2.0/umd/react-dom.production.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@babel/standalone@7.20.6/babel.min.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="./config.js"></script>
  <script src="./js/Posts.js"></script>
  <script src="./js/Comment.js"></script>
</head>
<body>
  <div id="root"></div>
  <script type="text/babel">
    // Post Component
    function Post({ id, title, date, content, comments, addComment, ticker, toggleFavorite }) {
      const [showCommentForm, setShowCommentForm] = React.useState(false);
      const [commentText, setCommentText] = React.useState('');
      const [stockPrice, setStockPrice] = React.useState('Loading...');
      const [priceChange, setPriceChange] = React.useState(null);
      const [isLiked, setIsLiked] = React.useState(() => {
        return localStorage.getItem(`like-${id}`) === 'true';
      });
      const [isFavorited, setIsFavorited] = React.useState(() => {
        return localStorage.getItem(`favorite-${id}`) === 'true';
      });

      // Toggle like state
      const handleLikeToggle = () => {
        const newLikedState = !isLiked;
        setIsLiked(newLikedState);
        localStorage.setItem(`like-${id}`, newLikedState);
      };

      // Toggle favorite state
      const handleFavoriteToggle = () => {
        const newFavoritedState = !isFavorited;
        setIsFavorited(newFavoritedState);
        localStorage.setItem(`favorite-${id}`, newFavoritedState);
        toggleFavorite(id, newFavoritedState);
      };

      // Fetch stock price
      const fetchStockPrice = async () => {
        try {
          const response = await fetch(
            `https://financialmodelingprep.com/api/v3/quote/${ticker}?apikey=${API_CONFIG.FMP_API_KEY}`
          );
          const data = await response.json();
          if (data && data[0] && data[0].price) {
            setStockPrice(`$${parseFloat(data[0].price).toFixed(2)}`);
            const changePercent = parseFloat(data[0].changesPercentage);
            setPriceChange(changePercent);
          } else {
            setStockPrice('Price unavailable');
          }
        } catch (error) {
          console.error('Error fetching stock price:', error);
          setStockPrice('Error fetching price');
        }
      };

      // Schedule next update
      const scheduleNextUpdate = () => {
        const now = new Date();
        const isWeekday = now.getDay() >= 1 && now.getDay() <= 5; // Monday–Friday
        if (!isWeekday) {
          // Skip to next Monday 9:30 AM
          const nextMonday = new Date(now);
          nextMonday.setDate(now.getDate() + ((8 - now.getDay()) % 7));
          nextMonday.setHours(9, 30, 0, 0);
          const timeUntilNext = nextMonday - now;
          return setTimeout(() => {
            fetchStockPrice();
            scheduleNextUpdate();
          }, timeUntilNext);
        }

        // Set next update to 9:30 AM or 4:00 PM EDT
        const today930AM = new Date(now.getFullYear(), now.getMonth(), now.getDate(), 9, 30, 0);
        const today4PM = new Date(now.getFullYear(), now.getMonth(), now.getDate(), 16, 0, 0);
        let nextUpdate;

        if (now < today930AM) {
          nextUpdate = today930AM;
        } else if (now < today4PM) {
          nextUpdate = today4PM;
        } else {
          // Next day’s 9:30 AM
          nextUpdate = new Date(now.getFullYear(), now.getMonth(), now.getDate() + 1, 9, 30, 0);
        }

        const timeUntilNext = nextUpdate - now;
        return setTimeout(() => {
          fetchStockPrice();
          scheduleNextUpdate();
        }, timeUntilNext);
      };

      // Initialize price fetch and schedule updates
      React.useEffect(() => {
        if (!ticker) return;

        fetchStockPrice(); // Initial fetch
        const timeoutId = scheduleNextUpdate();
        return () => clearTimeout(timeoutId);
      }, [ticker]);

      const handleCommentSubmit = (e) => {
        e.preventDefault();
        if (commentText.trim()) {
          addComment(id, {
            text: commentText,
            author: 'Anonymous',
            date: new Date().toLocaleDateString('en-US', {
              year: 'numeric',
              month: 'long',
              day: 'numeric',
              hour: 'numeric',
              minute: 'numeric',
            }),
          });
          setCommentText('');
          setShowCommentForm(false);
        }
      };

      return (
        <article className="mb-8 p-6 bg-white rounded-lg shadow-md">
          <h2 className="text-2xl font-bold mb-2 text-black">{title}</h2>
          <p className="text-gray-600 text-sm mb-4">{date}</p>
          <p className="text-black mb-4">{content}</p>
          {ticker && (
            <div className="stock-box mx-auto w-11/12 sm:w-5/6 lg:w-4/5 bg-black border border-black rounded p-2 my-4 text-center">
              <p className="text-white mb-2">
                Current {ticker} Stock Price:{' '}
                <span className={priceChange >= 0 ? 'text-lime-400' : 'text-red-400'}>
                  {stockPrice}
                  {priceChange !== null && ` (${priceChange.toFixed(2)}%)`}
                </span>
              </p>
              <div className="flex justify-center space-x-4">
                <button
                  onClick={handleLikeToggle}
                  className="text-white hover:text-gray-300 text-sm sm:text-base"
                >
                  {isLiked ? '♥ Liked' : '♡ Like'}
                </button>
                <button
                  onClick={handleFavoriteToggle}
                  className="text-white hover:text-gray-300 text-sm sm:text-base"
                >
                  {isFavorited ? '★ Unfavorite' : '☆ Favorite this stock'}
                </button>
              </div>
            </div>
          )}
          <button
            onClick={() => setShowCommentForm(!showCommentForm)}
            className="bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600"
          >
            {showCommentForm ? 'Cancel' : 'Add Comment'}
          </button>
          {showCommentForm && (
            <form onSubmit={handleCommentSubmit} className="mt-4">
              <textarea
                value={commentText}
                onChange={(e) => setCommentText(e.target.value)}
                placeholder="Write your comment..."
                className="w-full p-2 border rounded text-black"
                rows="4"
              />
              <button
                type="submit"
                className="mt-2 bg-green-500 text-white px-4 py-2 rounded hover:bg-green-600"
              >
                Submit Comment
              </button>
            </form>
          )}
          <div className="mt-4">
            <h3 className="text-lg font-semibold text-black">Comments</h3>
            {comments.length > 0 ? (
              comments.map((comment, index) => (
                <Comment
                  key={index}
                  text={comment.text}
                  author={comment.author}
                  date={comment.date}
                />
              ))
            ) : (
              <p className="text-gray-600">No comments yet.</p>
            )}
          </div>
        </article>
      );
    }

    // Main Blog Component
    function Blog() {
      const [posts, setPosts] = React.useState(postsData);
      const [favorites, setFavorites] = React.useState(() => {
        const saved = localStorage.getItem('favorites');
        return saved ? JSON.parse(saved) : [];
      });

      // Toggle favorite status
      const toggleFavorite = (postId, isFavorited) => {
        let updatedFavorites;
        if (isFavorited) {
          updatedFavorites = [...favorites, postId];
        } else {
          updatedFavorites = favorites.filter(id => id !== postId);
        }
        setFavorites(updatedFavorites);
        localStorage.setItem('favorites', JSON.stringify(updatedFavorites));
      };

      // Filter favorite posts
      const favoritePosts = posts
        .filter(post => favorites.includes(post.id))
        .sort((a, b) => a.id - b.id); // Sort by ID for consistency

      // All posts (for non-favorites section)
      const allPosts = posts.sort((a, b) => a.id - b.id);

      const addComment = (postId, newComment) => {
        setPosts(posts.map(post =>
          post.id === postId
            ? { ...post, comments: [...post.comments, newComment] }
            : post
        ));
      };

      return (
        <div className="min-h-screen bg-black text-white">
          <header className="bg-red-600 text-white py-6">
            <div className="max-w-4xl mx-auto px-4 flex justify-between items-center">
              <h1 className="text-4xl font-bold">SleepLess Stock Thoughts</h1>
              <a href="search.html" className="text-lg hover:underline">Search Stocks</a>
            </div>
          </header>
          <main className="max-w-4xl mx-auto py-8 px-4">
            {favoritePosts.length > 0 && (
              <section className="mb-12">
                <h2 className="text-2xl font-bold mb-4 text-white">Favorites</h2>
                {favoritePosts.map(post => (
                  <Post
                    key={post.id}
                    id={post.id}
                    title={post.title}
                    date={post.date}
                    content={post.content}
                    comments={post.comments}
                    addComment={addComment}
                    ticker={post.ticker}
                    toggleFavorite={toggleFavorite}
                  />
                ))}
              </section>
            )}
            <section>
              <h2 className="text-2xl font-bold mb-4 text-white">All Posts</h2>
              {allPosts.map(post => (
                <Post
                  key={post.id}
                  id={post.id}
                  title={post.title}
                  date={post.date}
                  content={post.content}
                  comments={post.comments}
                  addComment={addComment}
                  ticker={post.ticker}
                  toggleFavorite={toggleFavorite}
                />
              ))}
            </section>
          </main>
        </div>
      );
    }

    // Render the app
    const root = ReactDOM.createRoot(document.getElementById('root'));
    root.render(<Blog />);
  </script>
</body>
</html>